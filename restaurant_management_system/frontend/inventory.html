<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inventory - RMS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app-layout">
        <div id="sidebar-container"></div>
        <main class="main-content">
            <div class="container">
                <div class="flex justify-between items-center mb-4">
                    <h1>Inventory</h1>
                    <button class="btn btn-primary" onclick="openAddInventoryModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Item
                    </button>
                </div>

                <div class="card" style="padding: 0; overflow: hidden;">
                    <div id="inventory-list">Loading...</div>
                </div>
            </div>
        </main>
    </div>
    <!-- Add/Edit Inventory Modal -->
    <div id="inventoryModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Inventory Item</h2>
                <button onclick="closeModal()" class="modal-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <form id="inventoryForm">
                <div class="modal-body">
                    <input type="hidden" id="itemId">
                    <div class="form-group">
                        <label class="form-label">Item Name</label>
                        <input type="text" id="itemName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="itemQuantity" class="form-control" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit (e.g., kg, liters, pcs)</label>
                        <input type="text" id="itemUnit" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Low Stock Threshold</label>
                        <input type="number" id="itemThreshold" class="form-control" step="0.01" value="10" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal()" class="btn" style="background: transparent; border: 1px solid var(--border); color: var(--text-muted);">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script src="main.js"></script>
    <script>
        requireAuth();
        async function loadInventory() {
            const res = await apiRequest('/inventory/items/');
            if (res && res.ok) {
                const items = await res.json();
                const container = document.getElementById('inventory-list');
                if (items.length === 0) {
                    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No inventory items found.</div>';
                    return;
                }
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(i => `
                                <tr>
                                    <td style="font-weight: 500; color: var(--text-main);">${i.name}</td>
                                    <td style="color: var(--text-muted);">${i.quantity}</td>
                                    <td style="color: var(--text-muted);">${i.unit}</td>
                                    <td>
                                        ${i.is_low_stock 
                                            ? '<span class="badge badge-danger">Low Stock</span>' 
                                            : '<span class="badge badge-success">In Stock</span>'}
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;" onclick="openEditModal(${i.id})">Edit</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                document.getElementById('inventory-list').innerText = 'Failed to load inventory.';
            }
        }
        
        function openAddInventoryModal() {
            document.getElementById('modalTitle').innerText = 'Add Inventory Item';
            document.getElementById('itemId').value = '';
            document.getElementById('inventoryForm').reset();
            document.getElementById('inventoryModal').classList.add('show');
        }

        async function openEditModal(id) {
            const res = await apiRequest(`/inventory/items/${id}/`);
            if (res && res.ok) {
                const item = await res.json();
                document.getElementById('modalTitle').innerText = 'Edit Inventory Item';
                document.getElementById('itemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemQuantity').value = item.quantity;
                document.getElementById('itemUnit').value = item.unit;
                document.getElementById('itemThreshold').value = item.threshold;
                document.getElementById('inventoryModal').classList.add('show');
            }
        }

        function closeModal() {
            document.getElementById('inventoryModal').classList.remove('show');
        }

        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const data = {
                name: document.getElementById('itemName').value,
                quantity: document.getElementById('itemQuantity').value,
                unit: document.getElementById('itemUnit').value,
                threshold: document.getElementById('itemThreshold').value
            };

            const url = id ? `/inventory/items/${id}/` : '/inventory/items/';
            const method = id ? 'PUT' : 'POST';

            const res = await apiRequest(url, method, data);
            if (res && res.ok) {
                closeModal();
                loadInventory();
            } else {
                alert('Failed to save item');
            }
        });

        loadInventory();
    </script>
</body>
</html>
