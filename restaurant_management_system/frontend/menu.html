<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Menu - RMS</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .menu-item {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .menu-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .menu-item-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .menu-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .price-tag {
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div id="app-layout">
        <div id="sidebar-container"></div>
        <main class="main-content">
            <div class="container">
                <div class="flex justify-between items-center mb-6">
                    <h2>Menu Items</h2>
                    <button id="btn-add-item" class="btn btn-primary" onclick="openAddMenuModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add New Item
                    </button>
                </div>
                <div id="menu-grid" class="menu-grid">
                    <!-- Menu items will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Menu Item</h2>
                <button onclick="closeModal()" class="modal-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <form id="itemForm">
                <div class="modal-body">
                    <input type="hidden" id="itemId">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="itemName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="itemDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price (₹)</label>
                        <input type="number" id="itemPrice" class="form-control" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="itemCategory" class="form-control" required>
                            <!-- Categories loaded here -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal()" class="btn" style="background: transparent; border: 1px solid var(--border); color: var(--text-muted);">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script src="main.js"></script>
    <script>
        requireAuth();
        let categories = [];

        async function loadCategories() {
            const res = await apiRequest('/menu/categories/');
            if (res && res.ok) {
                categories = await res.json();
                const select = document.getElementById('itemCategory');
                select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        async function loadMenu() {
            const res = await apiRequest('/menu/items/');
            if (res && res.ok) {
                const items = await res.json();
                const container = document.getElementById('menu-grid');
                container.innerHTML = items.map(item => `
                    <div class="card menu-item" style="padding: 0; overflow: hidden; display: flex; flex-direction: column; background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); transition: transform 0.2s, box-shadow 0.2s;">
                        <div class="menu-item-image" style="height: 140px; background: #0f172a; position: relative; overflow: hidden;">
                            ${item.image ? 
                                `<img src="${item.image}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s;">` : 
                                `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #1e293b; color: #334155;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
                                 </div>`
                            }
                        </div>
                        <div class="menu-item-content" style="padding: 1rem; flex-grow: 1; display: flex; flex-direction: column;">
                            <div class="flex justify-between items-start mb-2">
                                <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #f8fafc; letter-spacing: -0.025em;">${item.name}</h3>
                                <span style="font-family: 'Inter', sans-serif; font-weight: 600; color: #e2e8f0; font-size: 0.95rem;">₹${item.price}</span>
                            </div>
                            <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.5rem; line-height: 1.5; font-weight: 400;">${item.description || 'Deliciously prepared for you.'}</p>
                            
                            <!-- Ingredients List -->
                            ${item.recipes && item.recipes.length > 0 ? `
                                <div style="margin-bottom: 1rem; background: rgba(15, 23, 42, 0.5); padding: 0.5rem; border-radius: 0.375rem; border: 1px solid rgba(255,255,255,0.05);">
                                    <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Ingredients:</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        ${item.recipes.map(r => `
                                            <span style="font-size: 0.75rem; color: #cbd5e1; background: rgba(255,255,255,0.05); padding: 0.125rem 0.375rem; border-radius: 0.25rem;">
                                                ${r.ingredient_name}: ${r.quantity_required}${r.unit}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="flex gap-2 mt-auto">
                                <button class="btn" style="flex: 1; justify-content: center; background: #3b82f6; border: none; color: white; font-weight: 500; padding: 0.5rem; border-radius: 0.5rem; transition: background 0.2s; font-size: 0.9rem;" onclick="addToOrder(${item.id})" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                    Add to Order
                                </button>
                                <button class="btn btn-edit-item" style="padding: 0.5rem; background: transparent; border: 1px solid #334155; color: #94a3b8; border-radius: 0.5rem; transition: all 0.2s;" onclick="openEditModal(${item.id})" onmouseover="this.style.borderColor='#94a3b8'; this.style.color='#f1f5f9'" onmouseout="this.style.borderColor='#334155'; this.style.color='#94a3b8'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                                </button>
                                <button class="btn btn-delete-item" style="padding: 0.5rem; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 0.5rem; transition: all 0.2s; margin-left: 0.25rem;" onclick="deleteItem(${item.id})" onmouseover="this.style.background='#ef4444'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#ef4444'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('menu-grid').innerText = 'Failed to load menu.';
            }
        }
        
        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const res = await apiRequest(`/menu/items/${id}/`, 'DELETE');
            if (res && res.ok) {
                loadMenu();
            } else {
                alert('Failed to delete item');
            }
        }

        function openAddMenuModal() {
            document.getElementById('modalTitle').innerText = 'Add Menu Item';
            document.getElementById('itemId').value = '';
            document.getElementById('itemForm').reset();
            document.getElementById('itemModal').classList.add('show');
        }

        async function openEditModal(id) {
            const res = await apiRequest(`/menu/items/${id}/`);
            if (res && res.ok) {
                const item = await res.json();
                document.getElementById('modalTitle').innerText = 'Edit Menu Item';
                document.getElementById('itemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemDescription').value = item.description;
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('itemCategory').value = item.category;
                document.getElementById('itemModal').classList.add('show');
            }
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('show');
        }

        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const data = {
                name: document.getElementById('itemName').value,
                description: document.getElementById('itemDescription').value,
                price: document.getElementById('itemPrice').value,
                category: document.getElementById('itemCategory').value
            };

            const url = id ? `/menu/items/${id}/` : '/menu/items/';
            const method = id ? 'PUT' : 'POST';

            const res = await apiRequest(url, method, data);
            if (res && res.ok) {
                closeModal();
                loadMenu();
            } else {
                alert('Failed to save item');
            }
        });

        function addToOrder(id) {
            // Placeholder for now, will implement with Order Management
            alert(`Item ${id} added to cart (logic coming soon)`);
        }

        loadCategories();
        loadMenu();
    </script>
</body>
</html>
