<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Menu - RMS</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1.25rem;
      }
      .menu-item {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: rgba(30, 41, 59, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .menu-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .menu-item img {
        width: 100%;
        height: 160px;
        object-fit: cover;
      }
      .menu-item-content {
        padding: 1.25rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .menu-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
      }
      .price-tag {
        font-weight: 700;
        color: #e2e8f0;
        font-family: 'Inter', sans-serif;
      }
      .ingredient-tag {
        font-size: 0.7rem;
        color: #94a3b8;
        background: rgba(15, 23, 42, 0.5);
        padding: 0.15rem 0.5rem;
        border-radius: 9999px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div id="app-layout">
      <div id="sidebar-container"></div>
      <main class="main-content">
        <div class="container">
          <div class="flex justify-between items-center mb-6">
            <h2>Menu Items</h2>
            <button
              id="btn-add-item"
              class="btn btn-primary"
              onclick="openAddMenuModal()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="margin-right: 0.5rem"
              >
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
              Add New Item
            </button>
          </div>
          <div id="menu-grid" class="menu-grid">
            <!-- Menu items will be loaded here -->
          </div>
        </div>
      </main>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add Menu Item</h2>
          <button onclick="closeModal()" class="modal-close">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <form id="itemForm">
          <div class="modal-body">
            <input type="hidden" id="itemId" />
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" id="itemName" class="form-control" required />
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea
                id="itemDescription"
                class="form-control"
                rows="3"
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Price (₹)</label>
              <input
                type="number"
                id="itemPrice"
                class="form-control"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">Category</label>
              <select id="itemCategory" class="form-control" required>
                <!-- Categories loaded here -->
              </select>
            </div>
            <div class="form-group">
                <label class="form-label">Ingredients</label>
                <div id="ingredientsList">
                    <!-- Ingredient rows will be added here -->
                </div>
                <button type="button" class="btn" onclick="addIngredientRow()" style="margin-top: 0.5rem; font-size: 0.85rem; padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.1); border: none; color: var(--text-muted); border-radius: 0.25rem;">
                    + Add Ingredient
                </button>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              onclick="closeModal()"
              class="btn"
              style="
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text-muted);
              "
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Item</button>
          </div>
        </form>
      </div>
    </div>

    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script src="main.js"></script>
    <script>
      requireAuth();
      let categories = [];
      let inventoryItems = [];

      async function loadInventory() {
        const res = await apiRequest("/inventory/items/");
        if (res && res.ok) {
          inventoryItems = await res.json();
        }
      }

      async function loadCategories() {
        const res = await apiRequest("/menu/categories/");
        if (res && res.ok) {
          categories = await res.json();
          const select = document.getElementById("itemCategory");
          select.innerHTML = categories
            .map((c) => `<option value="${c.id}">${c.name}</option>`)
            .join("");
        }
      }

      async function loadMenu() {
        const res = await apiRequest("/menu/items/");
        if (res && res.ok) {
          const items = await res.json();
          const container = document.getElementById("menu-grid");
          container.innerHTML = items
            .map(
              (item) => `
                    <div class="menu-item">
                        <div class="menu-item-content">
                            <div class="menu-item-header">
                                <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #f8fafc; letter-spacing: -0.025em;">${
                                  item.name
                                }</h3>
                                <span class="price-tag">₹${
                                  item.price
                                }</span>
                            </div>
                            <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.75rem; line-height: 1.4; font-weight: 400; flex-grow: 1;">${
                              item.description ||
                              "Deliciously prepared for you."
                            }</p>
                            
                            <!-- Ingredients List -->
                            ${
                              item.recipes && item.recipes.length > 0
                                ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 0.35rem; margin-bottom: 1rem;">
                                    ${item.recipes
                                      .map(
                                        (r) => `
                                        <span class="ingredient-tag">
                                            ${r.ingredient_name} <span style="opacity: 0.6; font-size: 0.9em;">${r.quantity_required}${r.unit}</span>
                                        </span>
                                    `
                                      )
                                      .join("")}
                                </div>
                            `
                                : ""
                            }

                            <div class="flex gap-2 mt-auto">
                                <button class="btn" style="flex: 1; justify-content: center; background: #3b82f6; border: none; color: white; font-weight: 500; padding: 0.5rem; border-radius: 0.5rem; transition: background 0.2s; font-size: 0.9rem;" onclick="addToOrder(${
                                  item.id
                                })" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                    Add to Order
                                </button>
                                <button class="btn btn-edit-item" style="padding: 0.5rem; background: transparent; border: 1px solid #334155; color: #94a3b8; border-radius: 0.5rem; transition: all 0.2s;" onclick="openEditModal(${
                                  item.id
                                })" onmouseover="this.style.borderColor='#94a3b8'; this.style.color='#f1f5f9'" onmouseout="this.style.borderColor='#334155'; this.style.color='#94a3b8'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                                </button>
                                <button class="btn btn-delete-item" style="padding: 0.5rem; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 0.5rem; transition: all 0.2s; margin-left: 0.25rem;" onclick="deleteItem(${
                                  item.id
                                })" onmouseover="this.style.background='#ef4444'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#ef4444'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");
        } else {
          document.getElementById("menu-grid").innerText =
            "Failed to load menu.";
        }
      }

      async function deleteItem(id) {
        if (!confirm("Are you sure you want to delete this item?")) return;

        const res = await apiRequest(`/menu/items/${id}/`, "DELETE");
        if (res && res.ok) {
          loadMenu();
        } else {
          alert("Failed to delete item");
        }
      }

      function openAddMenuModal() {
        document.getElementById("modalTitle").innerText = "Add Menu Item";
        document.getElementById("itemId").value = "";
        document.getElementById("itemForm").reset();
        document.getElementById("ingredientsList").innerHTML = ""; // Clear ingredients
        document.getElementById("itemModal").classList.add("show");
      }

      async function openEditModal(id) {
        const res = await apiRequest(`/menu/items/${id}/`);
        if (res && res.ok) {
          const item = await res.json();
          document.getElementById("modalTitle").innerText = "Edit Menu Item";
          document.getElementById("itemId").value = item.id;
          document.getElementById("itemName").value = item.name;
          document.getElementById("itemDescription").value = item.description;
          document.getElementById("itemPrice").value = item.price;
          document.getElementById("itemCategory").value = item.category;

          // Populate ingredients
          const ingredientsList = document.getElementById("ingredientsList");
          ingredientsList.innerHTML = "";
          if (item.recipes && item.recipes.length > 0) {
            item.recipes.forEach((recipe) => {
              addIngredientRow(
                recipe.inventory_item_id,
                recipe.quantity_required
              ); // Note: backend needs to send inventory_item_id in read serializer or we match by name
              // Wait, the read serializer sends 'ingredient_name'. We need the ID to select it in the dropdown.
              // Let's assume for now we can match by name or the backend sends ID.
              // Actually, looking at the serializer, RecipeSerializer sends: ingredient_name, quantity_required, unit. It does NOT send inventory_item_id.
              // I need to update the serializer to send inventory_item_id as well for the edit form to work correctly!
              // I will fix the serializer in a moment. For now, let's assume I have it or I can find it.

              // Finding ID from name since I have all inventoryItems loaded
              const invItem = inventoryItems.find(
                (i) => i.name === recipe.ingredient_name
              );
              if (invItem) {
                addIngredientRow(invItem.id, recipe.quantity_required);
              }
            });
          }

          document.getElementById("itemModal").classList.add("show");
        }
      }

      function closeModal() {
        document.getElementById("itemModal").classList.remove("show");
      }

      function addIngredientRow(selectedId = null, quantity = "") {
        const container = document.getElementById("ingredientsList");
        const div = document.createElement("div");
        div.className = "ingredient-row flex gap-2 mb-2 items-end";

        let options = '<option value="">Select Ingredient</option>';
        inventoryItems.forEach((item) => {
          const selected = item.id == selectedId ? "selected" : "";
          options += `<option value="${item.id}" ${selected}>${item.name} (${item.unit})</option>`;
        });

        div.innerHTML = `
                <div style="flex: 2;">
                    <select class="form-control ingredient-select" required>
                        ${options}
                    </select>
                </div>
                <div style="flex: 1;">
                    <input type="number" class="form-control ingredient-quantity" placeholder="Qty" step="0.01" value="${quantity}" required>
                </div>
                <button type="button" class="btn btn-delete-item" onclick="this.parentElement.remove()" style="padding: 0.5rem; border: 1px solid #ef4444; color: #ef4444;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
        container.appendChild(div);
      }

      document
        .getElementById("itemForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("itemId").value;

          // Collect ingredients
          const recipes = [];
          document.querySelectorAll(".ingredient-row").forEach((row) => {
            const inventory_item_id =
              row.querySelector(".ingredient-select").value;
            const quantity_required = row.querySelector(
              ".ingredient-quantity"
            ).value;
            if (inventory_item_id && quantity_required) {
              recipes.push({
                inventory_item_id: parseInt(inventory_item_id),
                quantity_required: parseFloat(quantity_required),
              });
            }
          });

          const data = {
            name: document.getElementById("itemName").value,
            description: document.getElementById("itemDescription").value,
            price: document.getElementById("itemPrice").value,
            category: document.getElementById("itemCategory").value,
            recipes: recipes,
          };

          const url = id ? `/menu/items/${id}/` : "/menu/items/";
          const method = id ? "PUT" : "POST";

          const res = await apiRequest(url, method, data);
          if (res && res.ok) {
            closeModal();
            loadMenu();
          } else {
            alert("Failed to save item");
          }
        });

      function addToOrder(id) {
        // Placeholder for now, will implement with Order Management
        alert(`Item ${id} added to cart (logic coming soon)`);
      }

      loadInventory();
      loadCategories();
      loadMenu();
    </script>
  </body>
</html>
